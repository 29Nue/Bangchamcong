<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8">
    <!-- !!! QUAN TR·ªåNG CHO MOBILE !!! -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <title>B·∫£ng T√≠nh L∆∞∆°ng & Ch·∫•m C√¥ng Tuy·ªát V·ªùi</title>
    <!-- Use Inter font family -->
    <style>
        /* --- CUSTOM CSS TO ENSURE RESPONSIVENESS (MOBILE-FIRST) --- */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f9fafb; min-height: 10vh; padding: 1.5rem; }
        
        /* Container ch√≠nh co gi√£n t·ªëi ƒëa 1280px v√† cƒÉn gi·ªØa */
        .main-container { max-width: 1280px; margin: 0 auto; background-color: #ffffff; padding: 1.5rem; border-radius: 1rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .header-title { font-size: 1.875rem; font-weight: 800; color: #4338ca; margin-bottom: 1.5rem; display: flex; align-items: center; }
        .input-group { display: flex; flex-direction: column; gap: 0.75rem; align-items: flex-end; margin-bottom: 2rem; padding: 1rem; background-color: #eef2ff; border-radius: 0.75rem; box-shadow: inset 0 1px 3px 0 rgba(0, 0, 0, 0.07); }
        .input-field { display: block; width: 100%; border-radius: 0.375rem; border: 1px solid #d1d5db; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); padding: 0.625rem; font-size: 0.875rem; }
        
        .btn-primary { padding: 0.625rem 1.5rem; background-color: #4f46e5; color: white; font-weight: 600; border-radius: 0.5rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1); transition: all 150ms ease-in-out; }
        .btn-primary:hover { background-color: #4338ca; }
        .btn-success { background-color: #10b981; }
        .btn-success:hover { background-color: #059669; }
        .btn-action { padding: 0.5rem 1rem; background-color: #4f46e5; color: white; font-weight: 600; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1); transition: all 150ms ease-in-out; }
        .btn-action:hover { background-color: #4338ca; transform: scale(1.05); }
        
        .sticky-header { position: sticky; top: 0; z-index: 10; background: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        
        /* *** QUAN TR·ªåNG: Cho ph√©p cu·ªôn ngang (scroll-x) v·ªõi b·∫£ng qu√° r·ªông *** */
        .scroll-x-container { 
            overflow-x: auto; 
            -webkit-overflow-scrolling: touch; /* Gi√∫p cu·ªôn m∆∞·ª£t m√† tr√™n iOS */
            border-radius: 0.5rem; 
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1); 
            border: 1px solid #f3f4f6; 
        }

        input[type="number"] { -moz-appearance: textfield; }
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        
        /* Media Query: Tr√™n m√†n h√¨nh l·ªõn (>= 640px) */
        @media (min-width: 640px) {
            .input-group { flex-direction: row; align-items: flex-end; }
            .input-group > div { flex-grow: 1; }
            /* Th√™m nh√¢n vi√™n - Chuy·ªÉn sang 5 c·ªôt */
            .grid-5-col { display: grid; grid-template-columns: repeat(5, minmax(0, 1fr)); }
            .grid-5-col .col-span-2 { grid-column: span 2 / span 2; }
        }
        /* Media Query: Tr√™n m√†n h√¨nh nh·ªè (Mobile) */
        @media (max-width: 639px) {
            .input-group > button { margin-top: 0.5rem; width: 100%; }
            /* Th√™m nh√¢n vi√™n - V·∫´n gi·ªØ 1 c·ªôt, n√∫t b·∫•m full width */
            .grid-5-col > div, .grid-5-col > button { width: 100%; }
        }
        
        /* CSS cho Ti√™u ƒë·ªÅ b·∫£ng k·∫øt qu·∫£ */
        .results-table th { 
            padding: 0.75rem 0.75rem; 
            font-size: 0.75rem; 
            font-weight: 500; 
            color: #0d9488; 
            text-transform: uppercase;
            text-align: center; 
        }
        
        /* CƒÉn ch·ªânh l·∫°i cho ph·∫ßn n·ªôi dung b·∫£ng k·∫øt qu·∫£ (tbody > td) */
        .results-table td {
            padding: 0.75rem 0.75rem; 
            white-space: nowrap; 
            font-size: 0.875rem;
            text-align: center; /* CƒÉn gi·ªØa m·∫∑c ƒë·ªãnh */
        }
        
        /* C·ªôt s·ªë th·ª© t·ª± (#) - CƒÉn gi·ªØa */
        .results-table td:nth-child(1) {
            text-align: center;
            color: #6b7280; 
        }

        /* C·ªôt T√™n - CƒÉn tr√°i (cho d·ªÖ ƒë·ªçc) */
        .results-table td:nth-child(2) {
            text-align: left; 
            font-weight: 500; 
            color: #111827;
        }

        /* --- C·ªòT S·ªê NG√ÄY C√îNG & GI·ªú OT: CƒÉn gi·ªØa ƒë·ªÉ th·∫≥ng h√†ng v·ªõi ti√™u ƒë·ªÅ --- */
        /* C·ªôt Ng√†y C√¥ng Th·ª±c (3) */
        .results-table td:nth-child(3) { text-align: center; color: #4f46e5; }
        /* C·ªôt T·ªïng Gi·ªù OT (4) */
        .results-table td:nth-child(4) { text-align: center; color: #6b7280; }
        /* C·ªôt C√¥ng Qƒê t·ª´ OT (1.5x) (5) */
        .results-table td:nth-child(5) { text-align: center; font-weight: 600; color: #059669; }
        /* C·ªôt T·ªîNG Ng√†y C√¥ng Qƒê (6) */
        .results-table td:nth-child(6) { text-align: center; font-weight: 800; color: #4338ca; }

        /* C√°c c·ªôt Ti·ªÅn t·ªá (L∆∞∆°ng) v·∫´n d√πng CƒÉn ph·∫£i ƒë·ªÉ cƒÉn th·∫≥ng h√†ng theo ƒë∆°n v·ªã ti·ªÅn */
        /* C·ªôt T·ªïng L∆∞∆°ng (7) */
        .results-table td:nth-child(7) { text-align: right; color: #374151; }
        /* C·ªôt Ph√≠ Admin (8) */
        .results-table td:nth-child(8) { text-align: right; color: #dc2626; }
        /* C·ªôt L∆Ø∆†NG TH·ª∞C NH·∫¨N (9) */
        .results-table td:nth-child(9) { text-align: right; font-weight: 800; color: #0d9488; }


    </style>
</head>
<body onload="initApp()">
    <div class="main-container">
        <h2 class="header-title">
            <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/><line x1="2" y1="22" x2="22" y2="22" stroke-width="3" /></svg>
            Web T√≠nh L∆∞∆°ng Nhanh & L√¢u D√†i (S·ª≠ d·ª•ng LocalStorage) üíº
        </h2>
        
        <!-- C·∫•u h√¨nh NƒÉm/Th√°ng -->
        <div id="appContainer">
            <div class="input-group">
                <div style="flex-grow: 1;">
                    <label for="year" class="block text-sm font-medium text-gray-700">NƒÉm</label>
                    <input type="number" id="year" value="2025" min="1900" class="input-field">
                </div>
                <div style="flex-grow: 1;">
                    <label for="month" class="block text-sm font-medium text-gray-700">Th√°ng</label>
                    <select id="month" class="input-field">
                        <!-- Options generated by JS -->
                    </select>
                </div>
                <button onclick="loadDataByDate()" class="btn-primary" style="min-width: 150px;">
                    Ch·ªçn Th√°ng & T·∫£i D·ªØ Li·ªáu
                </button>
            </div>

            <!-- Th√™m nh√¢n vi√™n -->
            <div class="p-4 bg-white border-b border-gray-200 mb-6 rounded-lg shadow-sm">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Th√™m Nh√¢n Vi√™n M·ªõi</h3>
                <!-- grid-5-col s·ª≠ d·ª•ng Media Query ƒë·ªÉ thay ƒë·ªïi layout tr√™n mobile -->
                <div class="grid-5-col">
                    <div class="col-span-2">
                        <label for="empName" class="block text-sm font-medium text-gray-700">T√™n nh√¢n vi√™n</label>
                        <input id="empName" class="input-field" placeholder="V√≠ d·ª•: Nguy·ªÖn VƒÉn A">
                    </div>
                    <div>
                        <label for="empRole" class="block text-sm font-medium text-gray-700">Lo·∫°i th·ª£</label>
                        <select id="empRole" class="input-field">
                            <option value="tho">Th·ª£ ch√≠nh</option>
                            <option value="phu">Th·ª£ ph·ª•</option>
                        </select>
                    </div>
                    <div>
                        <label for="empRate" class="block text-sm font-medium text-gray-700">M·ª©c l∆∞∆°ng/ng√†y</label>
                        <input id="empRate" class="input-field" type="number" placeholder="Ti·ªÅn (VNƒê)" step="1000" min="0">
                    </div>
                    <div>
                        <button type="button" class="w-full btn-success" style="padding: 0.625rem 1rem;" onclick="addEmployee()">
                            ‚ûï Th√™m
                        </button>
                    </div>
                </div>
            </div>

            <!-- B·∫£ng Ch·∫•m C√¥ng -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                <h3 style="font-size: 1.25rem; font-weight: 700; color: #1f2937;">B·∫£ng Ch·∫•m C√¥ng Th√°ng <span id="currentMonthYear"></span></h3>
                <span id="saveStatus" class="hidden" style="font-size: 0.875rem; font-weight: 600; transition: all 500ms;"></span>
            </div>
            
            <!-- *** ƒê·∫£m b·∫£o b·∫£ng n√†y lu√¥n n·∫±m trong scroll-x-container *** -->
            <div class="scroll-x-container mb-8">
                <table style="min-width: 100%; border-collapse: collapse; background-color: #fff; font-size: 0.875rem;">
                    <thead class="sticky-header">
                        <tr style="background-color: #f9fafb;">
                            <th style="padding: 0.75rem 0.5rem; font-size: 0.75rem; font-weight: 500; color: #6b7280; text-transform: uppercase; min-width: 50px;">Stt</th>
                            <th style="padding: 0.75rem 1rem; text-align: left; font-size: 0.75rem; font-weight: 500; color: #6b7280; text-transform: uppercase; min-width: 180px;">T√™n Nh√¢n Vi√™n</th>
                            <th style="padding: 0.75rem 0.5rem; font-size: 0.75rem; font-weight: 500; color: #6b7280; text-transform: uppercase; min-width: 80px;">Lo·∫°i</th>
                            <th style="padding: 0.75rem 0.5rem; font-size: 0.75rem; font-weight: 500; color: #6b7280; text-transform: uppercase; text-align: right; min-width: 120px;">L∆∞∆°ng/Ng√†y</th>
                            <!-- Days generated by JS -->
                        </tr>
                        <tr id="dayNumberRow" style="background-color: #f3f4f6;">
                            <th colspan="4"></th>
                            <!-- Day numbers and OT/Worked headers generated by JS -->
                        </tr>
                    </thead>
                    <tbody id="attendanceBody" style="background-color: white; border-top: 1px solid #e5e7eb;">
                        <!-- Employee rows generated by JS -->
                    </tbody>
                </table>
            </div>

            <!-- K·∫øt qu·∫£ t√≠nh l∆∞∆°ng -->
            <div style="display: flex; justify-content: flex-end; margin-bottom: 2rem;">
                <button type="button" class="btn-action" onclick="calculateAndSave()" style="padding: 0.75rem 2rem; font-size: 1.125rem; font-weight: 700;">
                    üí∞ T√≠nh L∆∞∆°ng Ngay
                </button>
            </div>
            
            <div id="resultsArea" class="hidden" style="margin-top: 2rem;">
                <h3 style="font-size: 1.25rem; font-weight: 700; color: #1f2937; margin-bottom: 1rem;">B·∫£ng K·∫øt Qu·∫£ T√≠nh L∆∞∆°ng</h3>
                <!-- *** ƒê·∫£m b·∫£o b·∫£ng n√†y lu√¥n n·∫±m trong scroll-x-container *** -->
                <div class="scroll-x-container">
                    <table class="results-table" style="min-width: 100%; border-collapse: collapse; font-size: 0.875rem;">
                        <thead style="background-color: #f0fdfa;">
                            <tr>
                                <th style="min-width: 50px;">#</th>
                                <th style="min-width: 180px;">T√™n</th>
                                <th style="min-width: 100px;">Ng√†y C√¥ng Th·ª±c</th>
                                <th style="min-width: 80px;">T·ªïng Gi·ªù OT</th>
                                <th style="min-width: 100px;">C√¥ng Qƒê t·ª´ OT (1.5x)</th>
                                <th style="min-width: 120px; font-size: 0.875rem; font-weight: 700;">T·ªîNG Ng√†y C√¥ng Qƒê</th>
                                <th style="min-width: 120px;">T·ªïng L∆∞∆°ng</th>
                                <th style="min-width: 100px;">Ph√≠ Admin</th>
                                <th style="min-width: 140px; font-size: 0.875rem; font-weight: 700;">L∆Ø∆†NG TH·ª∞C NH·∫¨N</th>
                            </tr>
                        </thead>
                        <tbody id="resultsBody" style="background-color: white; border-top: 1px solid #e5e7eb;">
                            <!-- Results generated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript & LocalStorage Logic -->
    <script>
        let employees = [];
        let currentYear = new Date().getFullYear();
        let currentMonth = new Date().getMonth() + 1;
        let daysInMonth = 0;
        
        window.saveTimer = null; // Debounce timer cho vi·ªác l∆∞u

        function initMonthSelector() {
            const select = document.getElementById('month');
            select.innerHTML = '';
            for (let m = 1; m <= 12; m++) {
                const option = document.createElement('option');
                option.value = m;
                option.textContent = `Th√°ng ${m}`;
                if (m === currentMonth) {
                    option.selected = true;
                }
                select.appendChild(option);
            }
        }

        async function initApp() {
            // 1. C√†i ƒë·∫∑t NƒÉm/Th√°ng hi·ªán t·∫°i v√† t√≠nh s·ªë ng√†y
            initMonthSelector();
            document.getElementById('year').value = currentYear;
            document.getElementById('month').value = currentMonth;
            
            // 2. C·∫≠p nh·∫≠t s·ªë ng√†y v√† render header ng√†y ngay l·∫≠p t·ª©c
            daysInMonth = calculateDaysInMonth(currentYear, currentMonth);
            document.getElementById('currentMonthYear').textContent = `${currentMonth}/${currentYear}`;
            renderDayHeaders(); 
            
            loadDataByDate(); // T·∫£i d·ªØ li·ªáu l·∫ßn ƒë·∫ßu b·∫±ng LocalStorage
        }
        
        function getLocalStorageKey() {
            const year = document.getElementById('year').value;
            const month = document.getElementById('month').value;
            return `salary_data_${month}-${year}`; 
        }

        function calculateDaysInMonth(year, month) {
            return new Date(year, month, 0).getDate();
        }

        /**
         * T·∫£i d·ªØ li·ªáu t·ª´ LocalStorage khi chuy·ªÉn ƒë·ªïi Th√°ng/NƒÉm
         */
        function loadDataByDate() {
            currentYear = parseInt(document.getElementById('year').value);
            currentMonth = parseInt(document.getElementById('month').value);
            
            // 1. C·∫≠p nh·∫≠t giao di·ªán
            daysInMonth = calculateDaysInMonth(currentYear, currentMonth);
            document.getElementById('currentMonthYear').textContent = `${currentMonth}/${currentYear}`;
            renderDayHeaders();
            
            // 2. T·∫£i d·ªØ li·ªáu t·ª´ LocalStorage
            const key = getLocalStorageKey();
            const storedData = localStorage.getItem(key);

            let loadedEmployees = [];
            let loadedResults = [];

            if (storedData) {
                try {
                    const data = JSON.parse(storedData);
                    loadedEmployees = Array.isArray(data.employees) ? data.employees : [];
                    loadedResults = Array.isArray(data.results) ? data.results : [];
                    console.log(`Data loaded for ${key} from localStorage. Employees: ${loadedEmployees.length}, Results: ${loadedResults.length}`);
                } catch (e) {
                    console.error("Error parsing data from localStorage:", e);
                }
            } else {
                console.log(`No data found for ${key} in localStorage, starting fresh.`);
            }
            
            // 3. C·∫≠p nh·∫≠t state v√† render
            employees = loadedEmployees;
            renderAttendanceTable();

            // 4. Render k·∫øt qu·∫£ n·∫øu c√≥
            if (loadedResults.length > 0) {
                renderResults(loadedResults);
            } else {
                document.getElementById('resultsArea').classList.add('hidden');
                document.getElementById('resultsBody').innerHTML = '';
            }

            // ·∫®n tr·∫°ng th√°i l∆∞u
            document.getElementById('saveStatus').classList.add('hidden');
        }
        
        function renderDayHeaders() {
            const dayRow = document.getElementById('dayNumberRow');
            // C√†i ƒë·∫∑t l·∫°i header
            dayRow.innerHTML = '<th colspan="4" style="padding: 0.75rem 0.5rem; font-size: 0.75rem; font-weight: 500; color: #6b7280; text-transform: uppercase;"></th>';

            for (let d = 1; d <= daysInMonth; d++) {
                dayRow.innerHTML += `
                    <th style="padding: 0.5rem 0.25rem; text-align: center; font-size: 10px; font-weight: 500; color: #4b5563; min-width: 50px; border-left: 1px solid #e5e7eb;">
                        <div style="font-weight: 700; font-size: 1rem;">${d}</div>
                        <div style="font-size: 9px; color: #6366f1;">L√†m/OT</div>
                    </th>`;
            }
            dayRow.innerHTML += `<th style="padding: 0.5rem 0.25rem; font-size: 0.75rem; font-weight: 500; color: #6b7280; text-transform: uppercase; min-width: 50px;">X√≥a</th>`;
        }

        /**
         * H√†m ch·ªâ t√≠nh to√°n k·∫øt qu·∫£ m√† KH√îNG render
         */
        function calculateResults() {
            // ƒê·ªãnh nghƒ©a gi·ªù l√†m vi·ªác chu·∫©n (8 gi·ªù/ng√†y)
            const HOURS_PER_DAY = 8.0; 
            const OT_MULTIPLIER = 1.5;

            const results = employees.map((emp, index) => {
                let days_actual = 0; // Ng√†y c√¥ng th·ª±c t·∫ø (worked = true)
                let total_ot_hours = 0.0; // T·ªïng gi·ªù OT
                
                // 1. T√≠nh to√°n ng√†y c√¥ng th·ª±c v√† t·ªïng gi·ªù OT
                for (const day in emp.att) {
                    const att = emp.att[day];
                    if (att.worked) {
                        days_actual += 1;
                    }
                    total_ot_hours += parseFloat(att.ot) || 0;
                }

                // 2. T√≠nh to√°n Ng√†y C√¥ng Quy ƒê·ªïi t·ª´ OT
                const ot_hours_converted = total_ot_hours * OT_MULTIPLIER; // Gi·ªù OT quy ƒë·ªïi (1.5x)
                const ot_days_converted = ot_hours_converted / HOURS_PER_DAY; // Ng√†y OT quy ƒë·ªïi (8h/ng√†y)
                
                // 3. T·ªïng Ng√†y C√¥ng Quy ƒê·ªïi
                const total_days_converted = days_actual + ot_days_converted;

                // 4. T√≠nh L∆∞∆°ng
                // L∆∞∆°ng v√† ph√≠ admin ƒë∆∞·ª£c t√≠nh d·ª±a tr√™n gi√° tr·ªã kh√¥ng l√†m tr√≤n (ƒë·ªô ch√≠nh x√°c cao nh·∫•t)
                const total_salary = total_days_converted * emp.rate;

                // 5. T√≠nh Ph√≠ Admin
                let admin_fee = 0;
                if (emp.role === 'tho') {
                    // Th·ª£ ch√≠nh: 50,000 VNƒê / ng√†y c√¥ng quy ƒë·ªïi
                    admin_fee = total_days_converted * 50000;
                } else {
                    // Th·ª£ ph·ª•: 20,000 VNƒê / ng√†y c√¥ng th·ª±c t·∫ø (kh√¥ng t√≠nh OT)
                    admin_fee = days_actual * 20000;
                }
                
                const net_salary = total_salary - admin_fee;

                // GI·ªÆ NGUY√äN S·ªê TH·∫¨P PH√ÇN TRONG OBJECT ƒê·ªÇ ƒê·∫¢M B·∫¢O T√çNH TO√ÅN CU·ªêI C√ôNG L√Ä CH√çNH X√ÅC
                return {
                    id: index + 1,
                    name: emp.name,
                    days_actual: days_actual,
                    total_ot_hours: total_ot_hours,
                    ot_days_converted: ot_days_converted, // C√¥ng quy ƒë·ªïi t·ª´ OT
                    total_days_converted: total_days_converted, // T·ªïng c√¥ng quy ƒë·ªïi
                    total_salary: total_salary,
                    admin_fee: admin_fee,
                    net_salary: net_salary
                };
            });
            return results;
        }

        /**
         * L∆∞u c·∫£ d·ªØ li·ªáu ch·∫•m c√¥ng v√† k·∫øt qu·∫£ t√≠nh l∆∞∆°ng v√†o LocalStorage
         */
        async function saveData() {
            const results = calculateResults(); // T√≠nh k·∫øt qu·∫£ tr∆∞·ªõc khi l∆∞u
            renderResults(results); // Hi·ªÉn th·ªã k·∫øt qu·∫£ sau khi t√≠nh

            const key = getLocalStorageKey();
            
            // Hi·ªÉn th·ªã tr·∫°ng th√°i ƒëang l∆∞u
            const statusEl = document.getElementById('saveStatus');
            statusEl.textContent = "ƒêang l∆∞u...";
            statusEl.style.color = '#fbbf24';
            statusEl.style.display = 'block';

            try {
                const dataToSave = { 
                    employees: employees,
                    results: results // L∆ØU K·∫æT QU·∫¢
                };
                localStorage.setItem(key, JSON.stringify(dataToSave));

                // C·∫≠p nh·∫≠t tr·∫°ng th√°i l∆∞u th√†nh c√¥ng
                statusEl.textContent = "ƒê√£ l∆∞u th√†nh c√¥ng!";
                statusEl.style.color = '#10b981';
                // ·∫®n sau 3 gi√¢y
                setTimeout(() => {
                    statusEl.style.display = 'none';
                }, 3000);
                console.log(`Employees and Results data saved successfully to localStorage key: ${key}`);

            } catch(error) {
                // C·∫≠p nh·∫≠t tr·∫°ng th√°i l·ªói
                statusEl.textContent = "L·ªói khi l∆∞u v√†o LocalStorage!";
                statusEl.style.color = '#dc2626';
                console.error("Error saving document to localStorage: ", error);
                
                // ·∫®n sau 5 gi√¢y
                setTimeout(() => {
                    statusEl.style.display = 'none';
                }, 5000);
            }
        }

        /**
         * H√†m ƒë·ªãnh d·∫°ng ti·ªÅn t·ªá.
         */
        function formatCurrency(amount) {
            const safeAmount = amount < 0 ? 0 : amount;
            // S·ª≠ d·ª•ng toLocaleString v·ªõi minimum/maximumFractionDigits ƒë·ªÉ gi·ªØ s·ªë th·∫≠p ph√¢n
            return safeAmount.toLocaleString('vi-VN', { 
                style: 'currency', 
                currency: 'VND',
                minimumFractionDigits: 0, 
                maximumFractionDigits: 2  
            }).replace('‚Ç´', ' VNƒê');
        }

        /**
         * H√†m ƒë·ªãnh d·∫°ng s·ªë ng√†y c√¥ng v√† gi·ªù OT theo y√™u c·∫ßu:
         * - Gi·ªØ t·ªëi ƒëa 2 ch·ªØ s·ªë th·∫≠p ph√¢n.
         */
        function formatDays(days) {
            // S·ª≠ d·ª•ng logic: l√†m tr√≤n ƒë·∫øn 2 ch·ªØ s·ªë th·∫≠p ph√¢n, sau ƒë√≥ d√πng parseFloat ƒë·ªÉ lo·∫°i b·ªè s·ªë 0 v√¥ nghƒ©a ·ªü cu·ªëi.
            let formatted = parseFloat(days.toPrecision(10)).toFixed(2);
            return parseFloat(formatted).toString(); 
        }

        function addEmployee(){
            const name = document.getElementById('empName').value.trim() || `NV${employees.length + 1}`;
            const role = document.getElementById('empRole').value;
            const rateVal = parseFloat(document.getElementById('empRate').value) || 0;
            
            employees.push({ name: name, role: role, rate: rateVal, att: {} });
            
            document.getElementById('empName').value = '';
            document.getElementById('empRate').value = '';
            renderAttendanceTable();
            saveData(); // L∆∞u ngay sau khi th√™m nh√¢n vi√™n
        }

        function removeEmployee(i) {
            employees.splice(i, 1);
            renderAttendanceTable();
            saveData(); // L∆∞u ngay sau khi x√≥a nh√¢n vi√™n
        }

        function updateAtt(empIdx, day, type, value) {
            if (!employees[empIdx].att) employees[empIdx].att = {};
            const dayStr = String(day); // ƒê·∫£m b·∫£o key ng√†y l√† string
            if (!employees[empIdx].att[dayStr]) employees[empIdx].att[dayStr] = { worked: false, ot: 0 };
            
            if (type === 'worked') {
                employees[empIdx].att[dayStr].worked = value;
            } else if (type === 'ot') {
                employees[empIdx].att[dayStr].ot = parseFloat(value) || 0;
            }
            
            // Debounce save (ƒë·ª£i 500ms tr∆∞·ªõc khi l∆∞u ƒë·ªÉ tr√°nh qu√° nhi·ªÅu l·∫ßn ghi khi ng∆∞·ªùi d√πng click li√™n t·ª•c)
            clearTimeout(window.saveTimer);
            window.saveTimer = setTimeout(saveData, 500); 
        }

        function renderAttendanceTable() {
            const tbody = document.getElementById('attendanceBody');
            tbody.innerHTML = '';

            employees.forEach((emp, idx) => {
                const tr = document.createElement('tr');
                tr.style.transition = 'background-color 100ms ease-in-out';
                tr.onmouseover = () => tr.style.backgroundColor = '#f9fafb';
                tr.onmouseout = () => tr.style.backgroundColor = 'white';

                let cells = `
                    <td style="padding: 0.75rem 0.5rem; white-space: nowrap; font-size: 0.875rem; font-weight: 500; color: #111827; border-right: 1px solid #e5e7eb; text-align: center;">${idx + 1}</td>
                    <td style="padding: 0.75rem 1rem; white-space: nowrap; font-size: 0.875rem; font-weight: 500; color: #111827; border-right: 1px solid #e5e7eb; text-align: left;">${emp.name}</td>
                    <td style="padding: 0.75rem 0.5rem; white-space: nowrap; font-size: 0.75rem; text-align: center; color: #4f46e5; font-weight: 600; border-right: 1px solid #e5e7eb;">${emp.role === 'tho' ? 'Th·ª£ ch√≠nh' : 'Th·ª£ ph·ª•'}</td>
                    <td style="padding: 0.75rem 0.5rem; white-space: nowrap; font-size: 0.875rem; text-align: right; color: #374151; border-right: 1px solid #e5e7eb;">${formatCurrency(emp.rate)}</td>
                `;

                for (let d = 1; d <= daysInMonth; d++) {
                    const dayStr = String(d);
                    const att = emp.att[dayStr] || { worked: false, ot: 0 };
                    const worked = att.worked ? 'checked' : '';
                    const ot = att.ot || '';
                    
                    // Custom Toggle Switch CSS (Minimal)
                    const toggleStyle = `
                        .toggle-switch { position: relative; display: inline-block; width: 36px; height: 20px; }
                        .toggle-switch input { opacity: 0; width: 0; height: 0; }
                        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 20px; }
                        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
                        input:checked + .slider { background-color: #10b981; }
                        input:checked + .slider:before { transform: translateX(16px); }
                    `;

                    cells += `
                        <td style="padding: 0.25rem; text-align: center; border-left: 1px solid #f3f4f6; border-right: 1px solid #f3f4f6;">
                            <style>${toggleStyle}</style>
                            <div style="display: flex; flex-direction: column; align-items: center; gap: 0.5rem;">
                                <!-- Checkbox cho Ng√†y l√†m -->
                                <!-- ƒê√£ tƒÉng k√≠ch th∆∞·ªõc Touch Target b·∫±ng c√°ch d√πng label l·ªõn bao quanh -->
                                <label class="toggle-switch">
                                    <input type="checkbox" onchange="updateAtt(${idx},${d},'worked',this.checked)" ${worked}>
                                    <span class="slider"></span>
                                </label>
                                <!-- Input cho OT -->
                                <input style="width: 64px; height: 28px; text-align: center; font-size: 0.75rem; border-radius: 0.375rem; border: 1px solid #d1d5db; padding: 0.125rem;" 
                                       type="number" step="0.25" min="0" placeholder="OT" value="${ot}" oninput="updateAtt(${idx},${d},'ot',this.value)">
                            </div>
                        </td>
                    `;
                }
                
                cells += `
                    <td style="padding: 0.75rem 0.5rem; white-space: nowrap; text-align: center;">
                        <button type="button" style="color: #dc2626; transition: color 150ms;" onmouseover="this.style.color='#991b1b'" onmouseout="this.style.color='#dc2626'" onclick="removeEmployee(${idx})">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>
                        </button>
                    </td>
                `;
                tr.innerHTML = cells;
                tbody.appendChild(tr);
            });
        }
        
        /**
         * H√†m T√≠nh L∆∞∆°ng v√† L∆∞u D·ªØ li·ªáu (ch·∫°y khi click n√∫t "T√≠nh L∆∞∆°ng Ngay")
         */
        function calculateAndSave() {
            if (employees.length === 0) {
                 // Kh√¥ng l√†m g√¨ n·∫øu kh√¥ng c√≥ nh√¢n vi√™n
                 document.getElementById('resultsArea').classList.add('hidden');
                 return;
            }
            saveData(); // T√≠nh to√°n, render v√† l∆∞u c·∫£ employees + results
            document.getElementById('resultsArea').scrollIntoView({ behavior: 'smooth' });
        }


        /**
         * H√†m ch·ªâ render k·∫øt qu·∫£ ra m√†n h√¨nh
         */
        function renderResults(results) {
            const resultsBody = document.getElementById('resultsBody');
            const resultsArea = document.getElementById('resultsArea');
            resultsBody.innerHTML = '';
            
            if (results.length === 0) {
                resultsArea.classList.add('hidden');
                return;
            }

            // Hi·ªÉn th·ªã k·∫øt qu·∫£
            results.forEach(r => {
                const tr = document.createElement('tr');
                tr.style.borderBottom = '1px solid #e5e7eb';
                tr.onmouseover = () => tr.style.backgroundColor = '#f0fdfa';
                tr.onmouseout = () => tr.style.backgroundColor = 'white';
                tr.style.transition = 'background-color 150ms ease-in-out';
                tr.innerHTML = `
                    <!-- C·ªôt # (S·ªë th·ª© t·ª±) - CƒÉn gi·ªØa -->
                    <td style="padding: 0.75rem 0.75rem; white-space: nowrap; font-size: 0.875rem; color: #6b7280; text-align: center;">${r.id}</td>
                    <!-- C·ªôt T√™n - CƒÉn tr√°i -->
                    <td style="padding: 0.75rem 0.75rem; white-space: nowrap; font-size: 0.875rem; font-weight: 500; color: #111827; text-align: left;">${r.name}</td>
                    <!-- C√°c c·ªôt s·ªë ng√†y c√¥ng/gi·ªù OT CƒÉn gi·ªØa -->
                    <td style="padding: 0.75rem 0.75rem; white-space: nowrap; font-size: 0.875rem; color: #4f46e5; text-align: center;">${formatDays(r.days_actual)}</td>
                    <td style="padding: 0.75rem 0.75rem; white-space: nowrap; font-size: 0.875rem; color: #6b7280; text-align: center;">${formatDays(r.total_ot_hours)}</td>
                    <td style="padding: 0.75rem 0.75rem; white-space: nowrap; font-size: 0.875rem; font-weight: 600; color: #059669; text-align: center;">${formatDays(r.ot_days_converted)}</td>
                    <td style="padding: 0.75rem 0.75rem; white-space: nowrap; font-size: 0.875rem; font-weight: 800; color: #4338ca; text-align: center;">${formatDays(r.total_days_converted)}</td>
                    <!-- C√°c c·ªôt ti·ªÅn t·ªá CƒÉn ph·∫£i -->
                    <td style="padding: 0.75rem 0.75rem; white-space: nowrap; font-size: 0.875rem; color: #374151; text-align: right;">${formatCurrency(r.total_salary)}</td>
                    <td style="padding: 0.75rem 0.75rem; white-space: nowrap; font-size: 0.875rem; color: #dc2626; text-align: right;">(${formatCurrency(r.admin_fee)})</td>
                    <td style="padding: 0.75rem 0.75rem; white-space: nowrap; font-size: 1.125rem; font-weight: 800; color: #0d9488; text-align: right;">${formatCurrency(r.net_salary)}</td>
                `;
                resultsBody.appendChild(tr);
            });

            resultsArea.classList.remove('hidden');
        }
    </script>
</body>
</html>